<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
  />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
      
    .map_container{
        
        width: 100%;
        height: 90vh;
    }
    #map { 
        width: 100%;
        height: 100%; }
</style>
</head>
<body>
    

<div class="container">
    <div class="row">  
        <div class="col-12 col-md-6">
            <div class="map_container">
                <div id="map"></div>
            </div>
        </div>
        <div class="col-12 col-md-6">
          <h2>站點資訊</h2>
          <div class="spinner-border" role="status" id="spinner">
            <span class="visually-hidden">Loading...</span>
          </div>
            <div class="row">
            <select class="form-select w-50" id="area1" aria-label="Default select example">
                <option selected>請先選擇縣市</option>
                <!-- <option value="1">One</option>
                <option value="2">Two</option>
                <option value="3">Three</option> -->
              </select>
              <select class="form-select w-50" aria-label="Default select example">
                <option selected>請先選擇縣市</option>
                <option value="1">One</option>
                <option value="2">Two</option>
                <option value="3">Three</option>
              </select>
            </div>
        <table class="table table-striped" id="my_table">
            <thead>
                <tr>
                  <th scope="col">區域</th>
                  <th scope="col">站點名稱</th>
                  <th scope="col">數量(剩餘/空位/總共)</th>
                  <th scope="col">地圖</th>
                  <th scope="col">經緯度</th>
                </tr>
              </thead>
              <tbody class="table-group-divider" id="data_rows">
                <!-- <tr>
                  <th scope="row">1</th>
                  <td>Mark</td>
                  <td>Otto</td>
                  <td><i class="fa-solid fa-map-location-dot"></i></td>
                  <td><i class="fa-solid fa-circle-info"  data-bs-toggle="tooltip" data-bs-placement="top"
                  data-bs-custom-class="custom-tooltip"
                  data-bs-title="This top tooltip is themed via CSS variables."></i></td>         
                </tr> -->
              </tbody>
          </table>
        </div>
    </div>
</div>

    

    

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>

        const taipeiYoubikeData="https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";
        
            // let map;
            const map=L.map("map");
            const markers=L.markerClusterGroup();
          window.onload=function(){
            const center=[25.0415001,121.5362220];
            const zoom=13;
            initMap(center,zoom);//參數自己設計 可以傳 center zoom
            fetchYoubikeData()          
            .then(data=>{
              console.log(data);
              clearMarkerGroup();
              const areagroup= groupArr(data,"sarea")
              console.log(areagroup);
              optionarea(areagroup);
           
              //fetch檔案 
              data.forEach(station => {
                renderingStationinfo(station);
                addMarker(station);                
                // console.log(station);
                
              });
              document.querySelector("#my_table").classList.remove("d-none");
              document.querySelector("#spinner").classList.add("d-none");
              
            })
          }
          //抓取點選的區域
          const area1=document.querySelector("#area1");
            area1.addEventListener("click",()=>{
            const selectedValue = area1.options[area1.selectedIndex].textContent;
            console.log(selectedValue);
            if(selectedValue!=="請先選擇縣市")
            {
              selectarea(selectedValue);
            }            
          })
          //選擇區域
          function selectarea(selectedValue){
            fetchYoubikeData()          
            .then(data=>{        
              console.log(data);     
              
              const selectdata=data.filter(item=>item.sarea===selectedValue);
              const LatLong=data.find(item=>item.sarea===selectedValue);
              console.log(selectdata);
              console.log(LatLong)
              clearMarkerGroup();
              // fetch檔案 
              selectdata.forEach(station => {
                renderingStationinfo(station);
                addMarker(station);                
                // console.log(station);
                
              });
              selectLatLong=[LatLong.latitude,LatLong.longitude];
              selectZoom=12;
              initMap(selectLatLong,selectZoom);
            })
          }
          
          //區域選單
          function optionarea(area){            
              console.log(area);
              area.forEach(item=>{
                const option=document.createElement("option");
                console.log(item);
                option.textContent=`${item}`;
                option.value=item.value;
                area1.append(option);
              })       
          }

        //抓到的資料分區
        function groupArr(sourceArr,propName){
            return sourceArr.reduce((acc,curr)=>{
               const groupingKey=curr[propName];
               if(!acc.includes(groupingKey)){
                acc.push(groupingKey);
               }                
               return acc;
            },[]);
        }       


            function clearMarkerGroup(){
              if(markers){
                markers.clearLayers();
              }
            }
            //map初始化
            function initMap(LatLong,zoom){
              //拿到外面共用
              //   map=L.map("map",{
              //   center:[25.0415001,121.5372731],
              //   zoom:13,
              // })
             

              //設定圖資
              L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
              }).addTo(map);

              map.setView(LatLong,zoom);
            }

            function addMarker(station){
              const marker=L.marker([station.latitude,station.longitude]);

              marker.bindPopup(`<p>${station.sna}</p>剩餘/空位/總共:${station.available_rent_bikes}/${station.available_return_bikes}/${station.total}`);

              markers.addLayer(marker);
              map.addLayer(markers);        
            }

          //撈出所有資料 Fn
          function renderingStationinfo(station){
            const tr=document.createElement("tr");
                const sareaTd=document.createElement("td");
                sareaTd.textContent=`${station.sarea}`;
                const stationNameTd=document.createElement("td");
                stationNameTd.textContent=`${station.sna}`;
                const infoTd=document.createElement("td");
                infoTd.textContent=`${station.available_rent_bikes}/${station.available_return_bikes}/${station.total}`;

                const mapTd=document.createElement("td");
                const mapicon=document.createElement("i");
                mapicon.classList.add("fa-solid", "fa-map-location-dot","pe-pointer");
                mapTd.append(mapicon);
                const latLngTd=document.createElement("td");
                const latLngIcon=document.createElement("i");
                latLngTd.append(latLngIcon);                
                latLngIcon.classList.add("fa-solid", "fa-circle-info");
                mapicon.addEventListener("click",()=>{
                  map.flyTo([station.latitude,station.longitude],18);
                });
                latLngIcon.setAttribute("data-bs-toggle","tooltip");
                latLngIcon.setAttribute("data-bs-title",`${station.latitude},${station.longitude}`);
                new bootstrap.Tooltip(latLngIcon);

                tr.append(sareaTd,stationNameTd,infoTd,mapTd,latLngTd)
                document.querySelector("#data_rows").append(tr);
          }
          // data-bs-toggle="tooltip" data-bs-title="Default tooltip"
          //fetch資料
          function fetchYoubikeData(){
            return fetch(taipeiYoubikeData).then(res=>res.json());
          }

           
    </script>
</body>
</html>